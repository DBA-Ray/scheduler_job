#!/bin/bash
#Author: DBA Ray

if [ $# -ne 1 ]

then

    echo "usage: `basename $0` [root_password]"

    exit 1

fi

source /etc/profile

time_start=`date +%s`

dumptime=`date "+%Y%m%d_%H%M%S"`

dbname={{ dbname }}

backupdir={{ backupdir }}/dumpbak

mysqldump -uroot -p${1} -B ${dbname} --single-transaction --set-gtid-purged=off --skip-triggers > ${backupdir}/${dbname}_${dumptime}.sql

mysqldump -uroot -p${1} -B ${dbname} -n -t -d -R -E --add-drop-trigger --triggers --single-transaction \
--set-gtid-purged=off > ${backupdir}/${dbname}_RET_${dumptime}.sql

time_end=`date +%s`

use_time=$((${time_end}-${time_start}))

echo "It takes ${use_time} seconds to backup the ${dbname} backup!!!"

cd ${backupdir}

scp -P {{ restore_host_port }} ${dbname}_${dumptime}.sql ${dbname}_RET_${dumptime}.sql root@{{ restore_host }}:/tmp

#tar -zcvf ${backupdir}/${dbname}_${dumptime}.tgz ${dbname}_${dumptime}.sql ${dbname}_RET_${dumptime}.sql

find ${backupdir}/ -mtime +7 -name "*" -exec rm -rf {} \;
