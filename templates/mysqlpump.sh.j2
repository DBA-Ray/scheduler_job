#!/bin/bash
#Author: DBA Ray

if [ $# -ne 1 ]

then

    echo "usage: `basename $0` [root_password]"

    exit 1

fi

#source /etc/profile

time_start=`date +%s`

dumptime=`date "+%Y%m%d_%H%M%S"`

dbname={{ dbname }}

backupdir={{ backupdir }}/dumpbak

mysqlpump -uroot -p${1} -B ${dbname} --single-transaction --set-gtid-purged=off --skip-definer \
--add-drop-database --add-drop-table --default-parallelism=16 > ${backupdir}/${dbname}_${dumptime}.sql

time_end=`date +%s`

use_time=$((${time_end}-${time_start}))

echo "It takes ${use_time} seconds to backup the ${dbname} backup!!!"

cd ${backupdir}

scp -P {{ restore_host_port }} ${dbname}_${dumptime}.sql root@{{ restore_host }}:/tmp

#tar -zcvf ${backupdir}/${dbname}_${dumptime}.tgz ${dbname}_${dumptime}.sql ${dbname}_RET_${dumptime}.sql

find ${backupdir}/ -mtime +7 -name "*" -exec rm -rf {} \;
